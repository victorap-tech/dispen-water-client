<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Dispen Agua</title>

<style>
  body {
    font-family: Arial;
    text-align: center;
    margin-top: 40px;
  }
  h1 { color: #007bff; }
  button {
    padding: 15px 30px;
    margin: 10px;
    font-size: 20px;
    border: none;
    background: #0a84ff;
    color: white;
    border-radius: 8px;
  }
  #estado { margin-top: 20px; font-size: 18px; }
</style>
</head>

<body>

<h1>¬°Gracias por tu pago! üíß</h1>
<p>Eleg√≠ el tipo de agua:</p>

<button onclick="enviar('caliente')">Agua CALIENTE</button>
<button onclick="enviar('fria')">Agua FR√çA</button>

<div id="estado">Conectando...</div>

<script>
const BACKEND = "https://web-production-e7d2.up.railway.app";
let pago_id = "";
let dispenser_id = "";
let tiempo_segundos = 20;

// Leer par√°metros del link ?pago_id=xxxxx&dispenser=ddd
const params = new URLSearchParams(window.location.search);
pago_id = params.get("pago_id") || "";
dispenser_id = params.get("dispenser") || "dispen-01";

document.getElementById("estado").innerText = "Listo para dispensar";

async function enviar(tipo) {
    document.getElementById("estado").innerText = "Enviando comando...";

    const body = {
        pago_id: pago_id,
        tipo: tipo,
        dispenser: dispenser_id
    };

    try {
        const r = await fetch(BACKEND + "/api/dispense_cmd", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const data = await r.json();
        if (data.ok) {
            document.getElementById("estado").innerText =
              "Esperando que el dispensador termine...";
        } else {
            document.getElementById("estado").innerText = "Error: " + data.error;
        }
    } catch (err) {
        document.getElementById("estado").innerText = "Error conectando al servidor.";
    }
}

</script>
</body>
</html>
